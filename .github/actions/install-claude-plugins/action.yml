name: "Install Claude Code & Plugins"
description: "Extracts Claude Code CLI and plugins from pre-built Docker image (fast, cached)"

inputs:
  image:
    description: "Claude runner Docker image to pull"
    required: false
    default: "ghcr.io/russianoracle-dev/claude-runner:latest"

outputs:
  claude_path:
    description: "Path to installed Claude executable"
    value: ${{ steps.extract.outputs.claude_path }}

runs:
  using: composite
  steps:
    - name: "ðŸ³ Pull claude-runner image"
      id: pull
      shell: bash
      run: |
        IMAGE="${{ inputs.image }}"
        echo "Pulling image: $IMAGE"
        docker pull "$IMAGE"
        echo "âœ… Image pulled"

    - name: "ðŸ“¦ Extract claude binary and plugins"
      id: extract
      shell: bash
      run: |
        IMAGE="${{ inputs.image }}"

        # Create a temporary container (not started) to copy files out
        CONTAINER_ID=$(docker create "$IMAGE")

        # Extract the Claude binary (remove stale file first to avoid permission issues)
        rm -f /tmp/claude-runner
        docker cp "$CONTAINER_ID:/root/.local/bin/claude" /tmp/claude-runner
        chmod +x /tmp/claude-runner

        # Extract plugins directory (non-fatal if missing â€” first run after clean image)
        mkdir -p "$HOME/.claude"
        docker cp "$CONTAINER_ID:/root/.claude/plugins" "$HOME/.claude/plugins" 2>/dev/null \
          && echo "âœ… Plugins extracted" \
          || echo "âš ï¸ No plugins dir in image, skipping"

        # Remove the temporary container
        docker rm "$CONTAINER_ID"

        # Verify binary works
        /tmp/claude-runner --version

        echo "claude_path=/tmp/claude-runner" >> "$GITHUB_OUTPUT"
        echo "âœ… Claude Code ready at /tmp/claude-runner"
